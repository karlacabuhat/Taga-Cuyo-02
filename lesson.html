<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/5.4.55/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <link rel="stylesheet" href="CSS/lesson_category.css">
    <title>Aralin Feature</title>
</head>
<body>
    <!-- SIDEBAR -->
         <!-- SIDEBAR -->
    <section id="sidebar">
        <a href="dashboard.html" class="brand"><img src="images/logo.png" width="70px" height="70px"> TAGA-CUYO</a>
        <ul class="side-menu">
            <li><a href="dashboard.html" class="active"><i class='bx bxs-dashboard icon'></i> Admin Dashboard</a></li>
            <li class="divider" data-text="main">Main</li>
            <li>
                <a href="#"><i class='bx bxs-inbox icon'></i> User Management <i class='bx bx-chevron-right icon-right'></i></a>
                <ul class="side-dropdown">
                    <li><a href="user_management_user.html" class="active"><i class='mdi mdi-account icon'></i> List of Users</a></li>
                    <li><a href="ManageStaff2.html"><i class='uil uil-users-alt icon'></i> Manage Staff</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class='bx bxs-graduation icon'class="active"></i> Learning Feature Status <i class='bx bx-chevron-right icon-right'></i></a>
                <ul class="side-dropdown">
                    <li><a href="Pending.html" class="active"><i class='bx bx-time icon'></i>Status</a></li>
                    <li><a href="lesson.html"><i class='bx bxs-book icon'></i>Aralin</a></li>
                    <li><a href="category.html"><i class='bx bxs-category icon'></i>Kategorya</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class='bx bxs-comment icon'></i> Support and Feedback <i class='bx bx-chevron-right icon-right'></i></a>
                <ul class="side-dropdown">
                    <li><a href="feedback2.html"><i class='bx bxs-message-rounded icon'></i>User Feedback</a></li>
                    <li><a href="user_support.html"><i class='uil uil-headphones-alt icon'></i>User Support</a></li>
                </ul>
            </li>
            <li><a href="terms_and_condition.html"><i class='bx bxs-file icon'></i> Terms and Condition</a></li>
            <li><a href="settings2.html"><i class='bx bxs-cog icon'></i> Settings</a></li>
        </ul>
    </section>
    <!-- SIDEBAR -->
        <!-- NAVBAR -->
        <section id="content">
            <nav>   
                <i class='bx bx-menu toggle-sidebar'></i>
                <form action="#">
                    <div class="form-group">
                        <input type="text" id="searchInput" placeholder="Search...">
                        <i class='bx bx-search icon'></i>
                    </div>
                </form>
                <div class="profile">
                    <div class="notification-icon" onclick="toggleNotificationDropdown()">
                        <i class='bx bxs-bell'></i>
                        <span id="notificationCounter" class="notification-counter"></span>
                    </div>
                    <div id="notificationDropdown" class="notification-dropdown hidden">
                        <h4></h4>
                        <ul id="notificationList">
                            <!-- Notifications will be populated here -->
                        </ul>
                    </div>
                    <img src="images/logo.png" alt="Profile Image">
                    <ul class="profile-link">
                        <li><a href="/settings2.html"><i class='bx bxs-cog'></i> Settings</a></li>
                        <li><a href="login2.html"><i class='bx bxs-log-out-circle'></i> Logout</a></li>
                    </ul>
                    </div>
            </nav>
            <!-- NAVBAR -->

        <main>
            <!-- Add Content Button -->
            <button id="addContentButton" class="btn_add" style="float: right; margin-right: -600px; color:white;">Add Content</button>
            <!-- Modal for Adding Content -->
            <div id="addContentModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>Add New Content</h2>
                    <form id="addContentForm">
                        <label for="lessonSelect">Select Lesson:</label>
                        <select id="lessonSelect">
                            <option value="" disabled selected>Select a lesson</option>
                            <!-- Dynamic options will be populated here -->
                        </select>
                        <label for="word">Word:</label>
                        <input type="text" id="word" name="word" required>
                        <label for="translated">Translated:</label>
                        <input type="text" id="translated" name="translated" required>
                        <label for="options">Options (comma separated):</label>
                        <input type="text" id="options" name="options">
                        <div class="submit-bb">
                            <button type="submit" class="btn btn-submit"style="background-color: rgb(32, 240, 46); border:none; padding: 10px 20px; border-radius: 5px; margin-top: 10px;">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Modal for Editing Content -->
            <div id="editContentModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeEditModal()">&times;</span>
                    <h2>Edit Content</h2>
                    <form id="editContentForm">
                        <input type="hidden" id="editWordId">
                        <label for="editWord">Word:</label>
                        <input type="text" id="editWord" name="word" required>
                        <label for="editTranslated">Translated:</label>
                        <input type="text" id="editTranslated" name="translated" required>
                        <label for="editOptions">Options (comma separated):</label>
                        <input type="text" id="editOptions" name="options">
                        <button type="submit" class="btn btn-submit" style="background-color: rgb(32, 240, 46); border:none; padding: 10px 20px; border-radius: 5px; margin-top: 10px;">Save Changes</button>
                    </form>
                </div>
            </div>

           
            <h3>Aralin</h3>
            <!-- Dropdown to filter lessons -->
            <label for="filterLesson" style="font-size: x-small;">Filter by Lesson:</label>
            <select id="filterLesson">
                <option value="">All Lessons</option>
                <!-- Options will be populated dynamically from Firebase -->
            </select>

            <!-- Table to display lessons and words -->
            <table id="lessonsTable">
                <thead>
                    <tr>
                        <th>Lesson Name</th>
                        <th>Word</th>
                        <th>Translated</th>
                        <th>Options</th>
                        <th>Action</th>
                        
                    </tr>
                </thead>
                <tbody id="lessonsTableBody">
                    <!-- Rows will be populated dynamically with Delete and Edit buttons -->
                </tbody>
                
            </table>
        </main>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqr7jav_7l0Y7gIhfTklJXnHPzjAYV8f4",
            authDomain: "taga-cuyo-app.firebaseapp.com",
            projectId: "taga-cuyo-app",
            storageBucket: "taga-cuyo-app.firebasestorage.app",
            messagingSenderId: "908851804845",
            appId: "1:908851804845:web:dff839dc552a573a23a424",
            measurementId: "G-NVSY2HPNX4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();
            
        // Show modal when Add Content button is clicked
document.getElementById('addContentButton').addEventListener('click', () => {
    document.getElementById('addContentModal').style.display = 'block';
});

// Close modal when close button is clicked
document.querySelector('.close-btn').addEventListener('click', () => {
    document.getElementById('addContentModal').style.display = 'none';
});

// Close edit modal when close button is clicked
function closeEditModal() {
    document.getElementById('editContentModal').style.display = 'none';
}
document.querySelector('.close-btn').addEventListener('click', closeEditModal);

// Close modal when clicking outside the modal content
window.addEventListener('click', function(event) {
    const addModal = document.getElementById('addContentModal');
    const editModal = document.getElementById('editContentModal');

    if (event.target === addModal) {
        addModal.style.display = 'none';
    }

    if (event.target === editModal) {
        editModal.style.display = 'none';
    }
});

        import { deleteDoc} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        
 window.deleteWord = async function(lessonId, wordId) { 
    const wordDocRef = doc(db, "lessons", lessonId, "words", wordId);
    console.log(`Attempting to delete word with ID: ${wordId} from lesson: ${lessonId}`);
    try {
        await deleteDoc(wordDocRef);
        alert("Content deleted successfully!");
        loadLessonsAndWords(); // Refresh table after deletion
    } catch (error) {
        console.error("Error deleting content:", error);
        alert("Failed to delete content. Please try again.");
    }
}

// Load lessons for the filter dropdown
async function loadFilterOptions() {
            const filterSelect = document.getElementById("filterLesson");
            const lessonsSnapshot = await getDocs(collection(db, "lessons"));
            lessonsSnapshot.forEach((doc) => {
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = doc.data().lesson_name || doc.id;
                filterSelect.appendChild(option);
            });
        }

        async function loadLessons() {
    try {
        const lessonsSnapshot = await getDocs(collection(db, "lessons"));
        const lessonSelect = document.getElementById("lessonSelect");

        // Clear existing options before populating new ones
        lessonSelect.innerHTML = '<option value="" disabled selected>Select a lesson</option>';

        // Populate the lessons dynamically
        lessonsSnapshot.forEach((doc) => {
            const option = document.createElement("option");
            option.value = doc.id;  // Use the document ID as the value
            option.textContent = doc.data().lesson_name || doc.id; // Use lesson_name field if it exists, otherwise doc ID
            lessonSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Error loading lessons:", error);
    }
}


// Call loadLessons when the page loads
document.addEventListener("DOMContentLoaded", loadLessons);

// Handle form submission
document.getElementById('addContentForm').addEventListener('submit', async (event) => {
    event.preventDefault();

    const lesson_name = document.getElementById('lessonSelect').value;
    const word = document.getElementById('word').value.trim();
    const translated = document.getElementById('translated').value.trim();
    const options = document.getElementById('options').value.split(',').map(opt => opt.trim());

    if (!lesson_name || !word || !translated) {
        alert("Please fill out all required fields.");
        return;
    }

    const lessonDocRef = doc(db, 'lessons', lesson_name);
    const wordsSubcollectionRef = collection(lessonDocRef, 'words');

    try {
        // Adding content to Firebase
        const wordDocRef = await addDoc(wordsSubcollectionRef, {
            word,
            translated,
            options,
            addedBy: auth.currentUser ? auth.currentUser.email : "unknown",
            timestamp: new Date()
        });

        // Update the lesson document with the timestamp of the last update
        await updateDoc(lessonDocRef, { lastUpdated: new Date() });

        // Closing modal and resetting form
        document.getElementById('addContentModal').style.display = 'none';
        document.getElementById('addContentForm').reset();
        alert("Content added successfully!");

        // Adding entry to history collection
        await addDoc(collection(db, "history"), {
            action: 'Added content to lesson',
            addedBy: auth.currentUser ? auth.currentUser.email : "unknown",
            documentId: wordDocRef.id, // Use the ID of the added word document
            lessonId: lesson_name,  // Now using lesson_name as lesson ID
            contentDetails: `Word: ${word}, Translated: ${translated}, Options: ${options.join(', ') || 'None'}`,
            adminAction: 'Content added',
            timestamp: new Date()
        });

        console.log("Content added successfully to Firebase.");
    } catch (error) {
        console.error("Error adding content:", error);
        alert("Failed to add content. Please try again.");
    }
});

async function loadHistory() {
        const historySnapshot = await getDocs(
            query(
                collection(db, 'history'),
                orderBy('timestamp', 'desc')
            )
        );

        const historyTableBody = document.getElementById('historyTableBody');
        historyTableBody.innerHTML = '';

        for (const historyDoc of historySnapshot.docs) {
            const data = historyDoc.data();
            const row = document.createElement('tr');

            // Apply background color based on adminAction
            if (data.adminAction === 'Deleted content') {
                row.style.backgroundColor = 'red'; // For deleted content
            } else if (data.adminAction === 'Approved content') {
                row.style.backgroundColor = 'green'; // For approved content
            } else if (data.adminAction === 'Edited content') {
                row.style.backgroundColor = 'green'; // For edited content
            } else if (data.adminAction === 'Dismissed content') {
                row.style.backgroundColor = 'gray'; // For dismissed content
            }

            row.innerHTML = `
                <td>${data.timestamp.toDate().toLocaleString()}</td>
                <td>${data.addedBy}</td>
                <td>${data.documentId}</td>
                <td>${data.lessonId}</td>
                <td>${data.contentDetails}</td>
                <td>${data.action}</td>
                <td>${data.adminAction}</td>
            `;
            historyTableBody.appendChild(row);
        }
    }
  // Load and display lessons and words
  async function loadLessonsAndWords(selectedLessonId = "") {
    const lessonsTableBody = document.getElementById("lessonsTableBody");
    lessonsTableBody.innerHTML = ""; // Clear previous content

    const lessonsSnapshot = await getDocs(collection(db, "lessons"));
    console.log("Loaded lessons:", lessonsSnapshot.size); // Debugging line to check loaded lessons
    for (const lessonDoc of lessonsSnapshot.docs) {
        const lessonData = lessonDoc.data();
        const lessonId = lessonDoc.id;
        const lessonName = lessonData.lesson_name;

        // Filter by the selected lesson if a specific lesson is chosen
        if (selectedLessonId && selectedLessonId !== lessonId) continue;

        const wordsSnapshot = await getDocs(collection(lessonDoc.ref, "words"));
        wordsSnapshot.forEach((wordDoc) => {
            const wordData = wordDoc.data();
            const wordId = wordDoc.id; // Capture document ID

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${lessonName}</td>
                <td>${wordData.word}</td>
                <td>${wordData.translated}</td>
                <td>${wordData.options.join(", ")}</td>
                <td>
                    <button onclick="deleteWord('${lessonId}', '${wordId}') "class="delete-btn">Delete</button>
                    <button onclick="editWord('${lessonId}', '${wordId}')"class="edit-btn">Edit</button>

                </td>
            `;
            lessonsTableBody.appendChild(row);
        });
    }
}
        // Listen for filter changes and reload data accordingly
        document.getElementById("filterLesson").addEventListener("change", (event) => {
            const selectedLessonId = event.target.value;
            loadLessonsAndWords(selectedLessonId);
        });
// Initialize options and load all lessons and words on page load
document.addEventListener("DOMContentLoaded", () => {
            loadFilterOptions();
            loadLessonsAndWords();
        });


window.editWord = async function (lessonId, wordId) {
    const wordDocRef = doc(db, "lessons", lessonId, "words", wordId);
    const wordDoc = await getDoc(wordDocRef);

    if (wordDoc.exists()) {
        const wordData = wordDoc.data();
        document.getElementById('editWordId').value = wordId;
        document.getElementById('editWord').value = wordData.word;
        document.getElementById('editTranslated').value = wordData.translated;
        document.getElementById('editOptions').value = wordData.options.join(", ");

        // Call loadLessons() to populate the lesson dropdown before displaying the modal
        await loadLessons(); // Ensure the dropdown is populated

        // Set the current lesson in the dropdown
        document.getElementById('lessonSelect').value = lessonId;

        document.getElementById('editContentModal').style.display = 'block';
    } else {
        alert("Content not found.");
    }
}
    // Handle form submission for editing content
    document.getElementById('editContentForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const lessonId = document.getElementById('lessonSelect').value;
        const wordId = document.getElementById('editWordId').value;
        const updatedWord = document.getElementById('editWord').value.trim();
        const updatedTranslated = document.getElementById('editTranslated').value.trim();
        const updatedOptions = document.getElementById('editOptions').value.split(',').map(opt => opt.trim());

        if (!updatedWord || !updatedTranslated) {
            alert("Please fill out all required fields.");
            return;
        }

        const wordDocRef = doc(db, "lessons", lessonId, "words", wordId);

        try {
            await updateDoc(wordDocRef, {
                word: updatedWord,
                translated: updatedTranslated,
                options: updatedOptions,
                lastUpdated: new Date()
            });

            // Close the edit modal and reset form
            document.getElementById('editContentModal').style.display = 'none';
            document.getElementById('editContentForm').reset();
            alert("Content updated successfully!");

            // Reload table data to show updates
            loadLessonsAndWords();
        } catch (error) {
            console.error("Error updating document:", error);
            alert("Failed to update content. Please try again.");
        }
    });
// Function to save the edited word and update Firestore without adding a new document
async function saveEditedWord(lessonId, wordId) {
    const wordDocRef = doc(db, "lessons", lessonId, "words", wordId);
    const updatedWord = document.getElementById('word').value.trim();
    const updatedTranslated = document.getElementById('translated').value.trim();
    const updatedOptions = document.getElementById('options').value.split(',').map(opt => opt.trim());

    try {
        await updateDoc(wordDocRef, {
            word: updatedWord,
            translated: updatedTranslated,
            options: updatedOptions,
            lastUpdated: new Date()
        });

        // Close the modal and reset form
        document.getElementById('addContentModal').style.display = 'none';
        document.getElementById('addContentForm').reset();
        alert("Content updated successfully!");

        // Reload table data to show updates
        loadLessonsAndWords();
    } catch (error) {
        console.error("Error updating document:", error);
        alert("Failed to update content. Please try again.");
    }

    // Reset the form submission handler to prevent duplicate submission handling
    document.getElementById('addContentForm').onsubmit = null;
}
    </script>
     <script src="scripts/script.js"></script>
</body>
</html>